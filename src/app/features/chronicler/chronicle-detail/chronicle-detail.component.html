<div class="chronicle-detail-container">
  @if (chronicle$ | async; as chronicle) {
    <div class="chronicle-content-wrapper">
      <app-panel class="chronicle-header-panel">
        <div class="toolbar-header">
          <div class="toolbar-left">
            <app-button size="small" (click)="onBack()">‚Üê Back</app-button>
            <div class="campaign-title">
              <h2>{{ chronicle.name }}</h2>
              @if (chronicle.isUserCreated) {
                <app-user-created-indicator />
              }
            </div>
          </div>

          <div class="toolbar-center">
            <div class="stat-item">
              <span class="stat-label">Status:</span>
              <span class="status-badge" [ngClass]="getStatusClass(chronicle.status)">
                {{ chronicle.status }}
              </span>
              @if (chronicle.isUserCreated) {
                @if (chronicle.status !== CampaignStatus.ACTIVE) {
                  <app-button size="small" (click)="onChangeStatus(CampaignStatus.ACTIVE)">
                    Activate
                  </app-button>
                }
                @if (chronicle.status !== CampaignStatus.COMPLETED) {
                  <app-button size="small" (click)="onChangeStatus(CampaignStatus.COMPLETED)">
                    Complete
                  </app-button>
                }
              }
            </div>
            <div class="stat-item">
              <span class="stat-label">Turn:</span>
              <span class="stat-value">{{ chronicle.currentTurn }}</span>
              @if (chronicle.isUserCreated && chronicle.status === CampaignStatus.ACTIVE) {
                <app-button size="small" (click)="onIncrementTurn()">+</app-button>
              }
            </div>
            <div class="stat-item">
              <span class="stat-label">Players:</span>
              <span class="stat-value">{{ chronicle.playerCount }}</span>
            </div>
          </div>

          <div class="toolbar-right">
            @if (chronicle.isUserCreated) {
              <app-button size="small" (click)="onEdit()">Edit</app-button>
              <app-button size="small" variant="danger" (click)="onDelete()">Delete</app-button>
            }
          </div>
        </div>
      </app-panel>
      
      @if (chronicle.description || chronicle.flavour) {
        <app-panel class="chronicle-description-panel">
          @if (chronicle.description) {
            <p class="description">{{ chronicle.description }}</p>
          }
          @if (chronicle.flavour) {
            <p class="flavour">{{ chronicle.flavour }}</p>
          }
        </app-panel>
      }

      <div class="campaign-content">
        <div class="factions-container">
          <div class="factions-header">
            <h2>Factions</h2>
          </div>
          
          <div class="factions-layout">
            <app-panel class="factions-list-panel">
              <div class="list-header">
                <h3>Faction List</h3>
                @if (chronicle.isUserCreated && chronicle.status === CampaignStatus.ACTIVE) {
                  <app-button size="small" (click)="onAddFaction()">
                    Add
                  </app-button>
                }
              </div>
              
              <div class="faction-list-scroll">
                <div class="faction-list">
                  @for (faction of factions$ | async; track faction.id) {
                    <app-faction-list-item
                      [faction]="faction"
                      [selected]="(selectedFactionId$ | async) === faction.id"
                      [showActions]="!!chronicle.isUserCreated"
                      (select)="onSelectFaction($event)"
                      (remove)="onRemoveFaction($event)"
                    />
                  } @empty {
                    <p class="no-factions">No factions yet</p>
                  }
                </div>
              </div>
            </app-panel>
            
            <app-panel class="faction-detail-panel">
              <app-faction-detail-view
                [faction]="selectedFaction$ | async"
                [canEdit]="!!chronicle.isUserCreated && chronicle.status === CampaignStatus.ACTIVE"
                (update)="onUpdateFaction($event)"
              />
            </app-panel>
          </div>
        </div>
      </div>
    </div>

    @if (showEditDialog) {
      <app-entity-form-dialog
        title="Edit Campaign"
        [entity]="chronicle"
        (save)="onSaveEdit($event)"
        (cancel)="onCancelEdit()"
      />
    }
  }
</div>